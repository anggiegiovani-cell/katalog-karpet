<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aneka Karpet Indah - Katalog Resmi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        .filter-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .ukuran-btn.selected { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
        #modal-zoom { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; cursor: zoom-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Animasi transisi gambar agar halus */
        img { transition: opacity 0.5s ease-in-out; opacity: 0; }
        img.loaded { opacity: 1; }
        .bg-placeholder { background-color: #e5e7eb; }
        .dark .bg-placeholder { background-color: #27272a; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-zinc-900 min-h-screen pb-20 font-sans transition-colors duration-300 text-gray-800 dark:text-gray-200">

    <header class="bg-white dark:bg-zinc-800 shadow-md sticky top-0 z-50">
        <div class="p-4 flex flex-col gap-3">
            <div class="relative flex items-center justify-center min-h-[48px]">
                <img src="https://i.ibb.co.com/Gv2LpsVy/Aneka-Karpet-Indah-logo-page-0001.jpg" alt="Aneka Karpet Indah" class="h-12 w-auto object-contain loaded" style="opacity:1">
                
                <button onclick="toggleDarkMode()" class="absolute right-0 p-2 rounded-xl bg-gray-100 dark:bg-zinc-700 text-gray-800 dark:text-yellow-400">
                    <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            <div class="relative">
                <input type="text" id="search-input" onkeyup="cariProduk()" placeholder="Cari merk atau motif..." class="w-full pl-10 pr-4 py-2.5 rounded-2xl bg-gray-50 dark:bg-zinc-700 border-none focus:ring-2 focus:ring-blue-500 text-sm">
                <svg class="w-4 h-4 absolute left-3.5 top-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>
        <div id="filter-bar" class="flex gap-2 overflow-x-auto px-4 pb-4 no-scrollbar">
            <button onclick="filterKoleksi('Semua', this)" class="filter-btn active whitespace-nowrap px-6 py-2 rounded-full border border-gray-200 dark:border-zinc-700 text-xs font-bold transition shadow-sm bg-white dark:bg-zinc-800 uppercase">SEMUA</button>
        </div>
    </header>

    <main class="p-3 max-w-5xl mx-auto">
        <div id="katalog-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <div class="col-span-full py-20 text-center text-gray-500 italic">Refreshing Inventory</div>
        </div>
    </main>

    <div id="modal-zoom" onclick="this.style.display='none'"><img id="img-zoom" class="w-full h-full object-contain p-4 loaded" style="opacity:1" src=""></div>

    <script>
        const SHEET_ID = '1iLJWtfJntcjZalA7q-FFIUNe8BXGT40za7kMeELXfJk';
        const WA_NUMBER = '628XXXXXXXXXX'; // GANTI NOMOR WHATSAPP ANDA
        const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        let semuaProduk = [];

        function formatRupiah(angka) {
            return parseInt(angka).toLocaleString('id-ID');
        }

        async function ambilData() {
            try {
                const res = await fetch(URL);
                const txt = await res.text();
                const json = JSON.parse(txt.substring(47, txt.length - 2));
                const rows = json.table.rows;
                
                let tempGroup = {};
                let uniqueID = 0;

                rows.forEach(row => {
                    if(!row.c[0]) return;
                    const koleksi = row.c[0] ? String(row.c[0].v) : 'Lainnya';
                    const namaRaw = row.c[1] ? String(row.c[1].v).trim() : '';
                    const ukuran = row.c[2] ? String(row.c[2].v) : '-';
                    const harga = row.c[3] ? row.c[3].v : 0;
                    const stok = row.c[4] ? row.c[4].v : 0;
                    const foto = row.c[5] ? String(row.c[5].v) : '';

                    let id;
                    if (namaRaw === '' || namaRaw === '-' || namaRaw.toLowerCase() === 'motif baru') {
                        id = `standalone-${uniqueID++}`;
                    } else {
                        id = `${koleksi}-${namaRaw}`;
                    }

                    if (!tempGroup[id]) {
                        // Simpan foto pertama sebagai cadangan jika baris variasi lain kosong
                        tempGroup[id] = { koleksi, nama: namaRaw || 'Motif Baru', fotoUtama: foto, variasi: [] };
                    }
                    
                    // Logika Fallback: Jika kolom foto kosong, pakai foto utama grup
                    const fotoFinal = (foto && foto !== '' && foto !== '-') ? foto : tempGroup[id].fotoUtama;

                    tempGroup[id].variasi.push({ ukuran, harga, stok, foto: fotoFinal });
                });

                semuaProduk = Object.values(tempGroup);
                buatTombolFilter();
                tampilkanKatalog(semuaProduk);
            } catch (err) {
                document.getElementById('katalog-container').innerHTML = "Kesalahan memuat data.";
            }
        }

        function tampilkanKatalog(data) {
            const container = document.getElementById('katalog-container');
            container.innerHTML = '';
            data.forEach((item, index) => {
                const cid = `c${index}`;
                const def = item.variasi[0];
                const waLink = `https://wa.me/${WA_NUMBER}?text=Halo Aneka Karpet Indah, saya mau tanya karpet ${item.koleksi} ${item.nama} ukuran ${def.ukuran}. %0AFoto: ${def.foto}`;

                container.innerHTML += `
                <div class="bg-white dark:bg-zinc-800 rounded-2xl overflow-hidden shadow-sm border border-gray-100 dark:border-zinc-700 flex flex-col hover:shadow-md transition">
                    <div class="relative aspect-[3/4] bg-placeholder overflow-hidden">
                        <img id="${cid}-img" 
                             data-src="${def.foto}" 
                             src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                             class="lazy-img w-full h-full object-cover cursor-zoom-in" 
                             onclick="openZoom(this.src)" 
                             onerror="this.src='https://via.placeholder.com/400x500?text=Foto+Error'">
                        <div class="absolute bottom-2 left-2 flex flex-wrap gap-1 pr-8">
                            ${item.variasi.map((v, i) => `
                                <button onclick="updVar('${cid}', '${v.ukuran}', '${v.harga}', '${v.stok}', this, '${v.foto}')" 
                                class="ukuran-btn text-[9px] px-2 py-1 rounded bg-white/90 dark:bg-zinc-800/90 font-bold border dark:border-zinc-600 dark:text-white ${i===0?'selected':''}">
                                    ${v.ukuran}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="p-3 flex flex-col flex-grow text-gray-900 dark:text-gray-100">
                        <p class="text-[9px] font-black text-blue-500 uppercase tracking-tighter">${item.koleksi}</p>
                        <h3 class="text-xs font-bold mb-2 uppercase line-clamp-2 leading-tight">${item.nama}</h3>
                        <div class="mt-auto pt-2 border-t dark:border-zinc-700">
                            <p id="${cid}-h" class="text-sm font-black italic text-gray-900 dark:text-white">Rp ${formatRupiah(def.harga)}</p>
                            <div class="flex items-center justify-between mt-2">
                                <span id="${cid}-s" class="text-[9px] font-bold ${def.stok!='0'?'text-green-600':'text-red-500'} uppercase">● STOK: ${def.stok}</span>
                                <a id="${cid}-wa" href="${waLink}" class="bg-white border border-gray-100 shadow-sm p-1 rounded-lg hover:scale-110 transition-transform flex items-center justify-center">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/2062095_application_chat_communication_logo_whatsapp_icon.svg" 
                                         alt="WhatsApp" class="w-5 h-5 loaded" style="opacity:1">
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            initLazyLoading();
        }

        function initLazyLoading() {
            const images = document.querySelectorAll('.lazy-img');
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.getAttribute('data-src');
                        img.onload = () => img.classList.add('loaded');
                        obs.unobserve(img);
                    }
                });
            }, { rootMargin: '100px' });
            images.forEach(img => observer.observe(img));
        }

        function updVar(cid, u, h, s, btn, f) {
            const img = document.getElementById(`${cid}-img`);
            img.classList.remove('loaded');
            document.getElementById(`${cid}-h`).innerText = `Rp ${formatRupiah(h)}`;
            img.src = f;
            img.onload = () => img.classList.add('loaded');
            const sel = document.getElementById(`${cid}-s`);
            sel.innerText = `● STOK: ${s}`;
            sel.className = `text-[9px] font-bold ${s!='0'?'text-green-600':'text-red-500'} uppercase`;
            
            const card = btn.closest('.bg-white, .dark\\:bg-zinc-800');
            const kol = card.querySelector('p').innerText;
            const nam = card.querySelector('h3').innerText;
            document.getElementById(`${cid}-wa`).href = `https://wa.me/${WA_NUMBER}?text=Halo Aneka Karpet Indah, saya mau tanya karpet ${kol} ${nam} ukuran ${u}. %0AFoto: ${f}`;
            
            btn.parentElement.querySelectorAll('.ukuran-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function buatTombolFilter() {
            const bar = document.getElementById('filter-bar');
            bar.innerHTML = '<button onclick="filterKoleksi(\'Semua\', this)" class="filter-btn active whitespace-nowrap px-6 py-2 rounded-full border border-gray-200 dark:border-zinc-700 text-xs font-bold transition shadow-sm bg-white dark:bg-zinc-800 uppercase">SEMUA</button>';
            const list = [...new Set(semuaProduk.map(p => p.koleksi))];
            list.forEach(k => {
                const btn = document.createElement('button');
                btn.innerText = k.toUpperCase();
                btn.className = "filter-btn whitespace-nowrap px-6 py-2 rounded-full border border-gray-200 dark:border-zinc-700 text-xs font-bold transition bg-white dark:bg-zinc-800";
                btn.onclick = (e) => filterKoleksi(k, e.target);
                bar.appendChild(btn);
            });
        }

        function filterKoleksi(kat, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            tampilkanKatalog(kat === 'Semua' ? semuaProduk : semuaProduk.filter(p => p.koleksi === kat));
        }

        function cariProduk() {
            const key = document.getElementById('search-input').value.toLowerCase();
            tampilkanKatalog(semuaProduk.filter(p => p.nama.toLowerCase().includes(key) || p.koleksi.toLowerCase().includes(key)));
        }

        function openZoom(s) {
            document.getElementById('img-zoom').src = s;
            document.getElementById('modal-zoom').style.display = 'flex';
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        
        ambilData();
    </script>
</body>
</html>

